{% extends 'base.html' %}

{% block title %}{{ page_title }} | Волейбольное сообщество{% endblock %}

{% block extra_head %}
<style>
    body {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 20px;
    }

    .calendar-container {
        background: white;
        border-radius: 20px;
        padding: 40px;
        width: 100%;
        max-width: 1200px;
        margin: 0 auto;
        box-shadow: 0 20px 40px rgba(0,0,0,0.2);
    }

    .calendar-header {
        text-align: center;
        margin-bottom: 2rem;
    }

    .calendar-header h1 {
        color: #4f46e5;
        font-weight: 700;
    }

    .calendar-navigation {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 2rem;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
    }

    .calendar-month-year {
        font-size: 1.5rem;
        font-weight: 600;
        color: #4f46e5;
    }

    .calendar-nav-btn {
        background: #4f46e5;
        color: white;
        border: none;
        padding: 8px 15px;
        border-radius: 50px;
        cursor: pointer;
        font-weight: 600;
    }

    .calendar-nav-btn:hover {
        background: #4338ca;
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 10px;
        margin-bottom: 2rem;
    }

    .calendar-day-header {
        text-align: center;
        padding: 10px;
        font-weight: 600;
        color: #4f46e5;
        background: #f8f9fa;
        border-radius: 8px;
    }

    .calendar-day {
        min-height: 120px;
        padding: 10px;
        background: #f8fafc;
        border-radius: 8px;
        border: 1px solid #e2e8f0;
        position: relative;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .calendar-day:hover {
        background: #e0e7ff;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .calendar-day.other-month {
        background: #f1f5f9;
        color: #94a3b8;
    }

    .calendar-day.today {
        background: #e0e7ff;
        border-color: #c7d2fe;
    }

    .day-number {
        position: absolute;
        top: 5px;
        right: 8px;
        font-weight: bold;
        color: #4f46e5;
        font-size: 1.1rem;
    }

    .day-game-count {
        position: absolute;
        top: 5px;
        left: 8px;
        background: #4f46e5;
        color: white;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 0.7rem;
        font-weight: bold;
    }

    .day-events {
        margin-top: 25px;
        display: flex;
        flex-direction: column;
        gap: 5px;
    }

    .event-badge {
        background: #dbeafe;
        color: #1d4ed8;
        padding: 4px 8px;
        border-radius: 6px;
        font-size: 0.8rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: pointer;
        border-left: 3px solid #3b82f6;
    }

    .event-badge:hover {
        background: #bfdbfe;
    }

    .event-time {
        font-size: 0.7rem;
        color: #64748b;
    }

    /* Modal styles */
    .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
        background-color: white;
        margin: 5% auto;
        padding: 20px;
        border-radius: 15px;
        width: 80%;
        max-width: 600px;
        position: relative;
        animation: modalopen 0.4s;
    }

    @keyframes modalopen {
        from {opacity: 0; transform: translateY(-60px);}
        to {opacity: 1; transform: translateY(0);}
    }

    .close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        cursor: pointer;
        position: absolute;
        right: 15px;
        top: 10px;
    }

    .close:hover {
        color: #000;
    }

    .modal-header {
        border-bottom: 1px solid #eee;
        padding-bottom: 15px;
        margin-bottom: 15px;
    }

    .modal-body {
        max-height: 70vh;
        overflow-y: auto;
    }

    .game-item-modal {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 15px;
        margin-bottom: 10px;
        border-left: 5px solid #667eea;
    }

    .game-title-modal {
        font-weight: bold;
        color: #2d3748;
        margin-bottom: 5px;
    }

    .game-time-modal {
        color: #718096;
        font-size: 0.9rem;
        margin-bottom: 5px;
    }

    .game-location-modal {
        color: #718096;
        font-size: 0.9rem;
    }

    .events-list {
        margin-top: 2rem;
    }

    .event-item {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 15px;
        border-left: 5px solid #667eea;
        transition: transform 0.3s;
    }

    .event-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .event-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }

    .event-title {
        color: #2d3748;
        font-weight: 600;
        font-size: 1.2rem;
    }

    .event-date-time {
        color: #718096;
        font-size: 0.9rem;
    }

    .event-details {
        display: flex;
        gap: 20px;
        margin-top: 10px;
        flex-wrap: wrap;
    }

    .event-detail {
        display: flex;
        align-items: center;
        gap: 5px;
        color: #718096;
    }

    .btn-create-event {
        background: linear-gradient(90deg, #4f46e5, #7c3aed);
        color: white;
        border: none;
        padding: 12px 25px;
        border-radius: 50px;
        font-weight: 600;
        margin-top: 1rem;
        display: inline-flex;
        align-items: center;
        gap: 8px;
    }

    .btn-create-event:hover {
        background: linear-gradient(90deg, #4338ca, #6d28d9);
        color: white;
    }

    .links {
        text-align: center;
        margin-top: 1.5rem;
        color: #64748b;
    }

    .links a {
        color: #4f46e5;
        text-decoration: none;
        margin: 0 10px;
    }

    .links a:hover {
        text-decoration: underline;
    }

    .volleyball-icon {
        font-size: 3rem;
        color: #4f46e5;
        margin-bottom: 1rem;
        display: block;
    }

    @media (max-width: 768px) {
        .calendar-container {
            padding: 20px;
        }

        .calendar-grid {
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            min-height: 80px;
            padding: 5px;
        }

        .day-events {
            margin-top: 20px;
        }

        .event-badge {
            font-size: 0.7rem;
            padding: 3px 6px;
        }
    }
</style>
{% endblock %}

{% block body %}
<div class="calendar-container">
    <div class="calendar-header">
        <i class="fas fa-calendar-alt volleyball-icon"></i>
        <h1>{{ page_title }}</h1>
        <p class="text-muted">Просмотрите все запланированные волейбольные события</p>
    </div>

    <div class="calendar-navigation">
        <button class="calendar-nav-btn" onclick="prevMonth()">
            <i class="fas fa-chevron-left"></i> Пред.
        </button>
        <div class="calendar-month-year" id="currentMonthYear">
            <!-- Month and year will be populated by JavaScript -->
        </div>
        <button class="calendar-nav-btn" onclick="nextMonth()">
            След. <i class="fas fa-chevron-right"></i>
        </button>
    </div>

    <div class="calendar-grid" id="calendarGrid">
        <!-- Calendar will be populated by JavaScript -->
    </div>

    <div class="events-list">
        <h3><i class="fas fa-list me-2"></i>Все события</h3>
        {% if all_games %}
            {% for game in all_games %}
            <div class="event-item">
                <div class="event-header">
                    <div class="event-title">{{ game.title }}</div>
                    <div class="event-date-time">
                        <i class="far fa-calendar"></i> {{ game.game_date|date:"j E Y" }} в {{ game.game_time|time:"H:i" }}
                    </div>
                </div>
                <p>{{ game.description|default:"Описание отсутствует" }}</p>
                <div class="event-details">
                    <div class="event-detail">
                        <i class="fas fa-map-marker-alt"></i> {{ game.location|default:"Не указано" }}
                    </div>
                    <div class="event-detail">
                        <i class="fas fa-users"></i> {{ game.participants.count }}/{{ game.max_players }} участников
                    </div>
                    <div class="event-detail">
                        <i class="fas fa-user"></i> Организатор: {{ game.organizer.username }}
                    </div>
                    <div class="event-detail">
                        <i class="fas fa-baseball-ball"></i> {{ game.get_sport_type_display }}
                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="alert alert-info">
                <i class="fas fa-info-circle"></i> На данный момент нет запланированных событий.
            </div>
        {% endif %}
    </div>

    <div class="text-center">
        <a href="{% url 'create_game' %}" class="btn btn-create-event">
            <i class="fas fa-plus-circle"></i> Создать событие
        </a>
    </div>

    <div class="links">
        <a href="{% url 'home' %}"><i class="fas fa-home"></i> На главную</a>
        <a href="{% url 'map' %}"><i class="fas fa-map"></i> Карта площадок</a>
        <a href="{% url 'create_game' %}"><i class="fas fa-calendar-plus"></i> Создать игру</a>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    // Calendar data
    const gamesByDate = {{ games_by_date|safe }};

    // Current date for calendar
    let currentDate = new Date();
    let currentMonth = currentDate.getMonth();
    let currentYear = currentDate.getFullYear();

    // Day names
    const dayNames = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];

    // Month names
    const monthNames = [
        'Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь',
        'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'
    ];

    // Initialize calendar
    document.addEventListener('DOMContentLoaded', function() {
        renderCalendar(currentMonth, currentYear);
    });

    // Render calendar for specific month/year
    function renderCalendar(month, year) {
        // Update header
        document.getElementById('currentMonthYear').textContent = `${monthNames[month]} ${year}`;

        // Clear calendar grid
        const calendarGrid = document.getElementById('calendarGrid');
        calendarGrid.innerHTML = '';

        // Add day headers
        dayNames.forEach(dayName => {
            const headerCell = document.createElement('div');
            headerCell.className = 'calendar-day-header';
            headerCell.textContent = dayName;
            calendarGrid.appendChild(headerCell);
        });

        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1).getDay();
        const daysInMonth = new Date(year, month + 1, 0).getDate();

        // Calculate adjusted first day (with Monday as first day)
        let adjustedFirstDay = firstDay === 0 ? 6 : firstDay - 1; // Convert Sunday to index 6

        // Add empty cells for days before the first day
        for (let i = 0; i < adjustedFirstDay; i++) {
            const emptyCell = document.createElement('div');
            emptyCell.className = 'calendar-day other-month';
            calendarGrid.appendChild(emptyCell);
        }

        // Add cells for each day of the month
        const today = new Date();
        const isCurrentMonth = today.getMonth() === month && today.getFullYear() === year;
        const todayDate = today.getDate();

        for (let day = 1; day <= daysInMonth; day++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'calendar-day';

            // Check if this is today
            if (isCurrentMonth && day === todayDate) {
                dayCell.classList.add('today');
            }

            // Add day number
            const dayNumber = document.createElement('div');
            dayNumber.className = 'day-number';
            dayNumber.textContent = day;
            dayCell.appendChild(dayNumber);

            // Format date as YYYY-MM-DD for checking events
            const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;

            // Add game count indicator if there are games
            if (gamesByDate[dateStr]) {
                const gameCount = gamesByDate[dateStr].length;
                const gameCountElement = document.createElement('div');
                gameCountElement.className = 'day-game-count';
                gameCountElement.textContent = gameCount;
                dayCell.appendChild(gameCountElement);

                // Add events for this day if any
                const eventsContainer = document.createElement('div');
                eventsContainer.className = 'day-events';

                // Show only the first game if there's only one game on the day
                if (gameCount === 1) {
                    const event = gamesByDate[dateStr][0];
                    const eventBadge = document.createElement('div');
                    eventBadge.className = 'event-badge';
                    eventBadge.title = `${event.title} в ${event.time}`;

                    eventBadge.innerHTML = `
                        <i class="fas fa-volleyball-ball"></i>
                        <span>${event.title}</span>
                        <div class="event-time">${event.time}</div>
                    `;

                    // Add click handler to redirect to game page
                    eventBadge.addEventListener('click', function(e) {
                        e.stopPropagation();
                        window.location.href = `/game/${event.id}/`;
                    });

                    eventsContainer.appendChild(eventBadge);
                } else {
                    // If there are multiple games, show a generic indicator
                    const multipleEventsBadge = document.createElement('div');
                    multipleEventsBadge.className = 'event-badge';
                    multipleEventsBadge.innerHTML = `
                        <i class="fas fa-calendar-alt"></i>
                        <span>${gameCount} игр</span>
                    `;

                    eventsContainer.appendChild(multipleEventsBadge);
                }

                dayCell.appendChild(eventsContainer);
            }

            // Add click handler to the day cell to show all games for that day
            dayCell.addEventListener('click', function() {
                showDayGamesModal(dateStr, gamesByDate[dateStr]);
            });

            calendarGrid.appendChild(dayCell);
        }
    }

    // Redirect to game page
    function showEventDetails(event) {
        window.location.href = `/game/${event.id}/`;
    }

    // Navigation functions
    function prevMonth() {
        currentMonth--;
        if (currentMonth < 0) {
            currentMonth = 11;
            currentYear--;
        }
        renderCalendar(currentMonth, currentYear);
    }

    function nextMonth() {
        currentMonth++;
        if (currentMonth > 11) {
            currentMonth = 0;
            currentYear++;
        }
        renderCalendar(currentMonth, currentYear);
    }

    // Show day games in a modal
    function showDayGamesModal(dateStr, games) {
        if (!games) return;

        // Create modal HTML
        const modalHtml = `
            <div id="gamesModal" class="modal">
                <div class="modal-content">
                    <span class="close">&times;</span>
                    <div class="modal-header">
                        <h4>Игры на ${formatDate(dateStr)}</h4>
                    </div>
                    <div class="modal-body">
                        ${games.map(game => `
                            <div class="game-item-modal" style="cursor: pointer;" onclick="window.location.href='/game/${game.id}/'">
                                <div class="game-title-modal">${game.title}</div>
                                <div class="game-time-modal"><i class="far fa-clock"></i> ${game.time}</div>
                                <div class="game-location-modal"><i class="fas fa-map-marker-alt"></i> ${game.location || 'Место не указано'}</div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;

        // Add modal to body
        document.body.insertAdjacentHTML('beforeend', modalHtml);

        // Get the modal
        const modal = document.getElementById('gamesModal');

        // Get the <span> element that closes the modal
        const span = document.querySelector('.close');

        // When the user clicks on <span> (x), close the modal
        span.onclick = function() {
            modal.remove();
        }

        // When the user clicks anywhere outside of the modal, close it
        window.onclick = function(event) {
            if (event.target === modal) {
                modal.remove();
            }
        }

        // Show the modal
        modal.style.display = 'block';
    }

    // Helper function to format date for display
    function formatDate(dateStr) {
        const date = new Date(dateStr);
        const options = { day: 'numeric', month: 'long', year: 'numeric', weekday: 'long' };
        return date.toLocaleDateString('ru-RU', options);
    }
</script>
{% endblock %}

