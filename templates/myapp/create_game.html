{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8 mx-auto">
            <div class="content-box">
                <h3><i class="fas fa-plus-circle"></i> {{ page_title }}</h3>

                <form method="post" id="createGameForm">
                    {% csrf_token %}

                    {% if form.non_field_errors %}
                        <div class="alert alert-danger">
                            {% for error in form.non_field_errors %}
                                {{ error }}
                            {% endfor %}
                        </div>
                    {% endif %}

                    <div class="mb-3">
                        <label for="{{ form.title.id_for_label }}" class="form-label"><strong>{{ form.title.label }}</strong></label>
                        {{ form.title }}
                        {% if form.title.help_text %}
                            <small class="form-text text-muted">{{ form.title.help_text }}</small>
                        {% endif %}
                        {% if form.title.errors %}
                            <div class="text-danger">{{ form.title.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.sport_type.id_for_label }}" class="form-label"><strong>{{ form.sport_type.label }}</strong></label>
                                {{ form.sport_type }}
                                {% if form.sport_type.errors %}
                                    <div class="text-danger">{{ form.sport_type.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.skill_level.id_for_label }}" class="form-label"><strong>{{ form.skill_level.label }}</strong></label>
                                {{ form.skill_level }}
                                {% if form.skill_level.errors %}
                                    <div class="text-danger">{{ form.skill_level.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.game_date.id_for_label }}" class="form-label"><strong>{{ form.game_date.label }}</strong></label>
                                {{ form.game_date }}
                                {% if form.game_date.errors %}
                                    <div class="text-danger">{{ form.game_date.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.game_time.id_for_label }}" class="form-label"><strong>{{ form.game_time.label }}</strong></label>
                                {{ form.game_time }}
                                {% if form.game_time.errors %}
                                    <div class="text-danger">{{ form.game_time.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.end_time.id_for_label }}" class="form-label"><strong>{{ form.end_time.label }}</strong></label>
                        {{ form.end_time }}
                        {% if form.end_time.errors %}
                            <div class="text-danger">{{ form.end_time.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="court_search" class="form-label"><strong>{{ form.court.label }}</strong></label>
                        <input type="text" id="court_search" class="form-control" placeholder="Начните вводить название площадки..." autocomplete="off">
                        <input type="hidden" name="court" id="court_hidden" value="{{ form.court.value }}">
                        <div id="court_suggestions" class="dropdown-menu" style="display: none; max-height: 200px; overflow-y: auto; width: 100%;"></div>
                        {% if form.court.errors %}
                            <div class="text-danger">{{ form.court.errors }}</div>
                        {% endif %}
                        <div id="selected_court_display" class="mt-2">
                            {% if form.court.value %}
                                <span class="badge bg-info">Выбрана площадка: <span id="selected_court_name"></span></span>
                                <button type="button" class="btn btn-sm btn-outline-danger ms-2" onclick="clearCourtSelection()">×</button>
                            {% endif %}
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.location.id_for_label }}" class="form-label"><strong>{{ form.location.label }}</strong></label>
                        {{ form.location }}
                        {% if form.location.help_text %}
                            <small class="form-text text-muted">{{ form.location.help_text }}</small>
                        {% endif %}
                        {% if form.location.errors %}
                            <div class="text-danger">{{ form.location.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.description.id_for_label }}" class="form-label"><strong>{{ form.description.label }}</strong></label>
                        {{ form.description }}
                        {% if form.description.help_text %}
                            <small class="form-text text-muted">{{ form.description.help_text }}</small>
                        {% endif %}
                        {% if form.description.errors %}
                            <div class="text-danger">{{ form.description.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.max_players.id_for_label }}" class="form-label"><strong>{{ form.max_players.label }}</strong></label>
                                {{ form.max_players }}
                                {% if form.max_players.errors %}
                                    <div class="text-danger">{{ form.max_players.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="{{ form.price.id_for_label }}" class="form-label"><strong>{{ form.price.label }}</strong></label>
                                {{ form.price }}
                                {% if form.price.errors %}
                                    <div class="text-danger">{{ form.price.errors }}</div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <div class="form-check">
                            {{ form.is_private }}
                            <label class="form-check-label" for="{{ form.is_private.id_for_label }}">{{ form.is_private.label }}</label>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.contact_name.id_for_label }}" class="form-label"><strong>{{ form.contact_name.label }}</strong></label>
                        {{ form.contact_name }}
                        {% if form.contact_name.errors %}
                            <div class="text-danger">{{ form.contact_name.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="mb-3">
                        <label for="{{ form.contact_phone.id_for_label }}" class="form-label"><strong>{{ form.contact_phone.label }}</strong></label>
                        {{ form.contact_phone }}
                        {% if form.contact_phone.errors %}
                            <div class="text-danger">{{ form.contact_phone.errors }}</div>
                        {% endif %}
                    </div>

                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="fas fa-volleyball-ball"></i> Создать игру
                        </button>
                        <a href="{% url 'home' %}" class="btn btn-secondary">Отмена</a>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Функция для очистки выбранной площадки
function clearCourtSelection() {
    document.getElementById('court_hidden').value = '';
    document.getElementById('court_search').value = '';
    document.getElementById('selected_court_display').innerHTML = '';
    document.getElementById('selected_court_display').style.display = 'none';
}

document.addEventListener('DOMContentLoaded', function() {
    // Добавляем валидацию формы
    const form = document.getElementById('createGameForm');

    // Установим минимальную дату на сегодня
    const today = new Date().toISOString().split('T')[0];
    const dateInput = document.getElementById('{{ form.game_date.id_for_label }}');
    if (dateInput) {
        dateInput.setAttribute('min', today);
    }

    // При изменении даты игры, обновляем минимальное время
    dateInput.addEventListener('change', function() {
        const selectedDate = new Date(this.value);
        const currentDate = new Date();

        if (selectedDate.toDateString() === currentDate.toDateString()) {
            // Если выбрана сегодняшняя дата, установим минимальное время на текущее
            const hours = currentDate.getHours();
            const minutes = currentDate.getMinutes().toString().padStart(2, '0');
            const currentTime = `${hours.toString().padStart(2, '0')}:${minutes}`;

            const timeInput = document.getElementById('{{ form.game_time.id_for_label }}');
            if (timeInput) {
                timeInput.setAttribute('min', currentTime);
            }
        } else {
            // Если выбрана другая дата, сбросим ограничение
            const timeInput = document.getElementById('{{ form.game_time.id_for_label }}');
            if (timeInput) {
                timeInput.removeAttribute('min');
            }
        }
    });

    // Добавляем функциональность поиска площадок
    const courtSearchInput = document.getElementById('court_search');
    const courtHiddenInput = document.getElementById('court_hidden');
    const courtSuggestions = document.getElementById('court_suggestions');
    const selectedCourtDisplay = document.getElementById('selected_court_display');

    // Если уже выбрана площадка, отображаем её название
    if (courtHiddenInput.value) {
        fetch(`/api/court/${courtHiddenInput.value}/`)
            .then(response => response.json())
            .then(data => {
                if (data.name) {
                    document.getElementById('selected_court_name').textContent = data.name;
                    selectedCourtDisplay.style.display = 'block';
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // Функция для отображения результатов поиска
    function showSuggestions(suggestions) {
        courtSuggestions.innerHTML = '';

        if (suggestions.length === 0) {
            courtSuggestions.style.display = 'none';
            return;
        }

        suggestions.forEach(function(court) {
            const suggestionItem = document.createElement('a');
            suggestionItem.href = '#';
            suggestionItem.className = 'dropdown-item';
            suggestionItem.textContent = `${court.name} (${court.address})`;

            suggestionItem.addEventListener('click', function(e) {
                e.preventDefault();

                // Устанавливаем выбранную площадку
                courtHiddenInput.value = court.id;
                courtSearchInput.value = court.name;

                // Отображаем выбранную площадку
                document.getElementById('selected_court_name').textContent = court.name;
                selectedCourtDisplay.style.display = 'inline-block';

                // Скрываем подсказки
                courtSuggestions.style.display = 'none';
            });

            courtSuggestions.appendChild(suggestionItem);
        });

        courtSuggestions.style.display = 'block';
    }

    // Обработка ввода в поле поиска
    courtSearchInput.addEventListener('input', function() {
        const query = this.value.trim();

        if (query.length < 2) {
            courtSuggestions.style.display = 'none';
            return;
        }

        // Выполняем поиск площадок
        fetch(`/api/search-courts/?query=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                showSuggestions(data || []);
            })
            .catch(error => {
                console.error('Error searching courts:', error);
                courtSuggestions.style.display = 'none';
            });
    });

    // Скрываем подсказки при клике вне поля поиска
    document.addEventListener('click', function(e) {
        if (!courtSearchInput.contains(e.target) && !courtSuggestions.contains(e.target)) {
            setTimeout(() => {
                courtSuggestions.style.display = 'none';
            }, 150); // Небольшая задержка для обработки клика по элементу
        }
    });

    // Валидация формы перед отправкой
    form.addEventListener('submit', function(e) {
        if (courtHiddenInput.required && !courtHiddenInput.value) {
            e.preventDefault();
            alert('Пожалуйста, выберите площадку для игры.');
            return false;
        }
    });
});
</script>
{% endblock %}