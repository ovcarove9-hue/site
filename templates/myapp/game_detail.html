{% extends 'base.html' %}

{% block title %}{{ page_title }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h2>{{ game.title }}</h2>
                </div>
                <div class="card-body">
                    <p><strong>Дата:</strong> {{ game.game_date|date:"d.m.Y" }}</p>
                    <p><strong>Время:</strong> {{ game.game_time|time:"H:i" }}</p>
                    <p><strong>Место:</strong> {{ game.location }}</p>
                    <p><strong>Тип спорта:</strong> {{ game.get_sport_type_display }}</p>
                    <p><strong>Тип игры:</strong> {% if game.is_tournament %}Турнир{% else %}Обычная игра{% endif %}</p>
                    <p><strong>Уровень:</strong> {{ game.get_skill_level_display }}</p>
                    <p><strong>Описание:</strong> {{ game.description|default:"Нет описания" }}</p>
                    
                    <div class="mt-3">
                        <p><strong>Организатор:</strong>
                            <a href="{% url 'profile' user_id=game.organizer.id %}">{{ game.organizer.username }}</a>
                        </p>
                    </div>
                </div>
            </div>

            <!-- Participants section -->
            <div class="card mt-4">
                <div class="card-header bg-secondary text-white">
                    <h4>Все игроки, зарегистрировавшиеся на игру ({{ participants|length }}/{{ game.max_players }})</h4>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for participant in participants %}
                        <div class="col-md-3 col-6 mb-3 text-center">
                            <a href="{% url 'profile' user_id=participant.id %}">
                                {% if participant.profile.avatar %}
                                    <img src="{{ participant.profile.avatar.url }}" alt="{{ participant.username }}" class="rounded-circle" width="60" height="60">
                                {% else %}
                                    <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 60px; height: 60px;">
                                        <span class="text-muted">{{ participant.username|slice:":1"|upper }}</span>
                                    </div>
                                {% endif %}
                            </a>
                            <div class="mt-1">
                                <small>{{ participant.username }}</small>
                            </div>
                        </div>
                        {% empty %}
                        <div class="col-12">
                            <p class="text-muted">Пока никто не зарегистрировался на игру</p>
                        </div>
                        {% endfor %}
                    </div>

                    <!-- Display organizer as a participant -->
                    {% if game.organizer not in participants %}
                    <hr>
                    <div class="row">
                        <div class="col-12">
                            <h6>Организатор игры:</h6>
                            <div class="d-flex align-items-center">
                                <a href="{% url 'profile' user_id=game.organizer.id %}">
                                    {% if game.organizer.profile.avatar %}
                                        <img src="{{ game.organizer.profile.avatar.url }}" alt="{{ game.organizer.username }}" class="rounded-circle" width="40" height="40">
                                    {% else %}
                                        <div class="bg-light rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                                            <span class="text-muted">{{ game.organizer.username|slice:":1"|upper }}</span>
                                        </div>
                                    {% endif %}
                                </a>
                                <div class="ml-2 ml-sm-3">
                                    <small>{{ game.organizer.username }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">Информация об игре</h5>
                    <ul class="list-group list-group-flush">
                        <li class="list-group-item">
                            <strong>Всего мест:</strong> {{ game.max_players }}
                        </li>
                        <li class="list-group-item">
                            <strong>Свободных мест:</strong> {{ spots_left }}
                        </li>
                        <li class="list-group-item">
                            <strong>Занятых мест:</strong> {{ game.participants.count }}
                        </li>
                        {% if game.is_private %}
                        <li class="list-group-item">
                            <span class="badge badge-warning">Приватная игра</span>
                        </li>
                        {% endif %}
                    </ul>
                    
                    {% if user.is_authenticated %}
                    <div class="mt-3">
                        {% if is_participant or user == game.organizer %}
                        <div class="alert alert-success">
                            {% if user == game.organizer %}
                                Вы организатор этой игры
                            {% else %}
                                Вы зарегистрированы на эту игру
                            {% endif %}
                        </div>
                        {% if user != game.organizer %}
                        <form method="post" action="{% url 'leave_game' game_id=game.id %}">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-danger btn-block">Отказаться от участия</button>
                        </form>
                        {% endif %}
                        {% elif can_join %}
                        <a href="{% url 'join_game' game_id=game.id %}" class="btn btn-success btn-block">Записаться на игру</a>
                        {% else %}
                        {% if game.participants.count >= game.max_players %}
                        <div class="alert alert-info">
                            Все места заняты
                        </div>
                        {% else %}
                        <div class="alert alert-info">
                            Вы не можете принять участие
                        </div>
                        {% endif %}
                        {% endif %}

                        <!-- Ссылка на другие игры -->
                        {% if is_participant or user == game.organizer %}
                        <div class="mt-3">
                            <a href="{% url 'event_calendar' %}" class="btn btn-outline-primary btn-block">Другие игры</a>
                        </div>
                        {% endif %}
                    </div>
                    {% else %}
                    <div class="alert alert-info">
                        <a href="{% url 'login' %}">Войдите</a>, чтобы записаться на игру
                    </div>
                    {% endif %}
                    
                    <div class="mt-3">
                        <a href="{% url 'home' %}" class="btn btn-outline-secondary btn-block">Назад к главной</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}